name: Release

on:
  push:
    tags:
      - "v*"
      - "pango*"

env:
  CARGO_TERM_COLOR: always

  DOCKER_REGISTRY: ghcr.io

jobs:
  release-testnets:
    name: Release testnets
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/pango')
    steps:
      - name: Generate template data
        run: |
          echo 'Template data:'
          jq -n \
            --arg pangolin_proposal_compressed "1" \
            --arg pangolin_blake2_256_compressed "1" \
            --arg pangolin_runtime_version "1" \
            --arg pangoro_proposal_compressed "1" \
            --arg pangoro_blake2_256_compressed "1" \
            --arg pangoro_runtime_version "1" \
            --arg tag "1" \
            --arg sha "1" \
            '{
              pangolin_proposal_compressed: $pangolin_proposal_compressed,
              pangolin_blake2_256_compressed: $pangolin_blake2_256_compressed,
              pangolin_runtime_version: $pangolin_runtime_version,
              pangoro_proposal_compressed: $pangoro_proposal_compressed,
              pangoro_blake2_256_compressed: $pangoro_blake2_256_compressed,
              pangoro_runtime_version: $pangoro_runtime_version,
              tag: $tag,
              sha: $sha
            }' | tee shared/template_data.json

      - name: Render release page
        uses: jayamanikharyono/jinja-action@v0.1
        with:
          datafile: shared/template_data.json
          path: .github/release-testnets.md

      - name: Publish github release
        uses: softprops/action-gh-release@v1
        with:
          append_body: true
          body_path: ".github/release-testnets.md"
          files: |
            deploy/*
          generate_release_notes: true
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}

  clean-artifacts:
    name: Clean artifacts
    runs-on: ubuntu-latest
    needs: [release-mainnets, release-testnets]
    if: always()
    steps:
      - uses: geekyeggo/delete-artifact@v1
        with:
          name: darwinia-artifact
